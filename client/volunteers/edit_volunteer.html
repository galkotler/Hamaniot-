<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>×¢×¨×™×›×ª ×¤×¨×•×¤×™×œ ××ª× ×“×‘</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="../index.html">×“×£ ×”×‘×™×ª</a></li>
        <li><a href="volunteer_list.html">â¬… ×—×–×¨×” ×œ×¨×©×™××ª ××ª× ×“×‘×™×</a></li>
      </ul>
    </nav>
  </header>

  <div class="form-container">
    <h1>âœï¸ ×¢×¨×™×›×ª ×¤×¨×˜×™ ××ª× ×“×‘</h1>

    <form id="editVolunteerForm">
      <input type="hidden" id="volunteer_id" />

      <label for="full_name">×©× ××œ×:</label>
      <input type="text" id="full_name" name="full_name" required>

      <label for="age">×’×™×œ:</label>
      <input type="number" id="age" name="age" required>

      <label for="email">××™××™×™×œ:</label>
      <input type="email" id="email" name="email" required>

      <label for="phone">×˜×œ×¤×•×Ÿ:</label>
      <input type="tel" id="phone" name="phone" required>

      <label for="area">××–×•×¨ ××•×¢×“×£:</label>
      <input type="text" id="area" name="area">

      <label for="group">×§×‘×•×¦×ª ×’×™×œ:</label>
      <select id="group" name="group" required>
        <option value="">-- ×‘×—×¨ ×§×‘×•×¦×” --</option>
      </select>

      <label for="interests">×ª×—×•××™ ×¢× ×™×™×Ÿ:</label>
      <textarea id="interests" name="interests" rows="3"></textarea>

      <button type="submit">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
      <div id="responseMessage" class="success"></div>
    </form>
  </div>

  <footer>
    Â© 2025 ×¢××•×ª×ª ×—×× ×™×•×ª - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const volunteerId = params.get("id");
      const form = document.getElementById("editVolunteerForm");
      const responseMessage = document.getElementById("responseMessage");
      const BASE_URL = "https://hamaniot-3.onrender.com";

      if (!volunteerId) {
        alert("âŒ ××–×”×” ××ª× ×“×‘ ×—×¡×¨ ×‘×›×ª×•×‘×ª.");
        return;
      }

      // ×˜×¢×Ÿ ×§×‘×•×¦×•×ª ×œ×ª×•×š <select>

      async function loadGroups(selectedGroupId = "") {

        try {
          const res = await fetch(`${BASE_URL}/api/groups`);
          const groups = await res.json();
          const select = document.getElementById("group");
          select.innerHTML = `<option value="">-- ×‘×—×¨ ×§×‘×•×¦×” --</option>`;

          groups.forEach(group => {
            const option = document.createElement("option");
            option.value = group._id;
            option.textContent = group.age_category;
            if (group._id === selectedGroupId) {
              option.selected = true;
            }
            select.appendChild(option);
          });

        } catch (err) {
          alert("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×‘×•×¦×•×ª");
          console.error(err);
        }
      }

      // ×˜×¢×Ÿ ××ª ×¤×¨×˜×™ ×”××ª× ×“×‘
      try {
        const res = await fetch(`${BASE_URL}/api/volunteers/${volunteerId}`);
        const volunteer = await res.json();

        document.getElementById("volunteer_id").value = volunteer._id;
        document.getElementById("full_name").value = volunteer.full_name || "";
        document.getElementById("age").value = volunteer.age || "";
        document.getElementById("email").value = volunteer.email || "";
        document.getElementById("phone").value = volunteer.phone || "";
        document.getElementById("area").value = volunteer.area || "";
        document.getElementById("interests").value = volunteer.interests || "";

        await loadGroups(volunteer.group?._id);
      } catch (err) {
        alert("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”××ª× ×“×‘");
        console.error(err);
        return;
      }

      // ×©×œ×™×—×ª ×”×˜×•×¤×¡ ×œ×¢×“×›×•×Ÿ
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch(`${BASE_URL}/api/volunteers/${volunteerId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          if (res.ok) {
            responseMessage.textContent = "âœ… ×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”!";
            setTimeout(() => {
              window.location.href = "volunteer_list.html";
            }, 1000);
          } else {
            responseMessage.textContent = "âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×.";
            console.error(result);
          }
        } catch (err) {
          responseMessage.textContent = "âŒ ×©×’×™××ª ×¨×©×ª.";
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
