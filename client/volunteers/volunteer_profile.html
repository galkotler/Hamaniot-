<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×¤×¨×•×¤×™×œ ××ª× ×“×‘</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    .delete-button {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
    }
    .delete-button:hover {
      background-color: #d32f2f;
    }
    .edit-button {
      background-color: #f0c14b;
      color: black;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
      text-decoration: none;
    }
    .edit-button:hover {
      background-color: #ddb347;
    }
  </style>
</head>
<body>

  <!-- ×¡×¨×’×œ × ×™×•×•×˜ -->
  <header>
    <nav>
      <ul>
        <li><a href="../index.html">ğŸ  ×“×£ ×”×‘×™×ª</a></li>
        <li><a href="volunteer_list.html">â¬… ×—×–×¨×” ×œ×¨×©×™××ª ××ª× ×“×‘×™×</a></li>
      </ul>
    </nav>
  </header>

  <div class="profile-container">
    <h1>×¤×¨×•×¤×™×œ ××ª× ×“×‘</h1>

    <div class="profile-info">
      <p><span class="label">×©× ××œ×:</span> <span id="fullName"></span></p>
      <p><span class="label">×’×™×œ:</span> <span id="age"></span></p>
      <p><span class="label">××™××™×™×œ:</span> <span id="email"></span></p>
      <p><span class="label">×˜×œ×¤×•×Ÿ:</span> <span id="phone"></span></p>
      <p><span class="label">××–×•×¨ ××•×¢×“×£:</span> <span id="area"></span></p>
      <p><span class="label">×ª×—×•××™ ×¢× ×™×™×Ÿ:</span> <span id="interests"></span></p>
      <p><span class="label">×§×‘×•×¦×ª ×©×™×‘×•×¥:</span> <span id="assignedGroup"></span></p>
    </div>

    <!-- ×©×™×‘×•×¥ ×œ×§×‘×•×¦×” - ××•×¦×’ ×¨×§ ×œ×× ×”×œ -->
    <div id="groupAssignmentSection" style="display:none; margin-top: 20px; text-align: center;">
      <label for="groupSelect">×©×™×‘×•×¥ ×œ×§×‘×•×¦×”:</label>
      <select id="groupSelect">
        <option value="">-- ×‘×—×¨ ×§×‘×•×¦×” --</option>
      </select>
      <button id="assignGroupBtn">×©××•×¨</button>
    </div>

    <div class="action-buttons" style="margin-top: 20px; text-align: center;">
      <a id="editBtn" class="edit-button" href="#" style="display: none;">âœï¸ ×¢×¨×™×›×ª ×¤×¨×•×¤×™×œ</a>
      <button id="deleteBtn" class="delete-button" style="display: none;">ğŸ—‘ï¸ ××—×™×§×ª ××ª× ×“×‘</button>
    </div>
  </div>

  <footer>
    Â© 2025 ×¢××•×ª×ª ×—×× ×™×•×ª - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const checkRes = await fetch("http://localhost:3000/api/auth/check", {
          credentials: "include"
        });

        if (!checkRes.ok) {
          alert("âš ï¸ ×œ× ××—×•×‘×¨ ×œ××¢×¨×›×ª");
          window.location.href = "../index.html";
          return;
        }

        const user = await checkRes.json();
        const role = user.role;
        let volunteerId;

        // ×§×‘×™×¢×ª ×”-ID ×©×œ ×”××ª× ×“×‘ ×œ×¤×™ ×ª×¤×§×™×“
        if (role === "volunteer") {
          volunteerId = user.id;
        } else if (role === "admin") {
          const params = new URLSearchParams(window.location.search);
          volunteerId = params.get("id");
          if (!volunteerId) {
            alert("âŒ ×œ× × ××¦× ××–×”×” ××ª× ×“×‘ ×‘-URL");
            return;
          }
        } else {
          alert("âš ï¸ ××™×Ÿ ×œ×š ×”×¨×©××•×ª ×œ×¦×¤×•×ª ×‘×¤×¨×•×¤×™×œ ×–×”");
          return;
        }

        // ×©×œ×™×¤×ª × ×ª×•× ×™ ×”××ª× ×“×‘ ××”×©×¨×ª
        const res = await fetch(`http://localhost:3000/api/volunteers/${volunteerId}`, {
          credentials: "include"
        });
        if (!res.ok) throw new Error("×©×’×™××” ×‘×§×‘×œ×ª ×¤×¨×˜×™ ××ª× ×“×‘");

        const volunteer = await res.json();

        // ğŸ›¡ï¸ ×—×¡×™××ª ×’×™×©×” ×œ××ª× ×“×‘ ×–×¨ ×œ×¤×™ ××™××™×™×œ
        if (role === "volunteer" && volunteer.email !== user.email) {
          alert("âŒ ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×¤×¨×•×¤×™×œ ×–×”");
          window.location.href = "volunteer_list.html";
          return;
        }

        // ×”×¦×’×ª ×¤×¨×˜×™ ×”××ª× ×“×‘
        document.getElementById("fullName").textContent = volunteer.full_name || "";
        document.getElementById("age").textContent = volunteer.age || "";
        document.getElementById("email").textContent = volunteer.email || "";
        document.getElementById("phone").textContent = volunteer.phone || "";
        document.getElementById("area").textContent = volunteer.area || "";
        document.getElementById("interests").textContent = volunteer.interests || "";
        document.getElementById("assignedGroup").textContent =
          volunteer.group?.age_category || "×œ× ×©×•×‘×¥";

        // ×ª×¦×•×’×” ×•×›×œ×™× ×œ×× ×”×œ ×‘×œ×‘×“
        if (role === "admin") {
          document.getElementById("editBtn").href = `edit_volunteer.html?id=${volunteerId}`;
          document.getElementById("editBtn").style.display = "inline-block";
          document.getElementById("deleteBtn").style.display = "inline-block";

          document.getElementById("deleteBtn").addEventListener("click", async () => {
            if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××ª× ×“×‘?")) return;
            try {
              const delRes = await fetch(`http://localhost:3000/api/volunteers/${volunteerId}`, {
                method: "DELETE"
              });
              if (!delRes.ok) throw new Error("×©×’×™××” ×‘××—×™×§×”");
              alert("ğŸ—‘ï¸ ×”××ª× ×“×‘ × ××—×§ ×‘×”×¦×œ×—×”");
              window.location.href = "volunteer_list.html";
            } catch (err) {
              console.error("âš ï¸ ×©×’×™××” ×‘××—×™×§×ª ××ª× ×“×‘:", err);
              alert("âš ï¸ ×©×’×™××” ×‘××—×™×§×ª ××ª× ×“×‘");
            }
          });

          // ×©×™×‘×•×¥ ×œ×§×‘×•×¦×”
          document.getElementById("groupAssignmentSection").style.display = "block";
          const groupRes = await fetch("http://localhost:3000/api/groups");
          const groups = await groupRes.json();
          const select = document.getElementById("groupSelect");

          groups.forEach(group => {
            const option = document.createElement("option");
            option.value = group._id;
            option.textContent = group.age_category;
            if (volunteer.group?._id === group._id) option.selected = true;
            select.appendChild(option);
          });

          document.getElementById("assignGroupBtn").addEventListener("click", async () => {
            const groupId = select.value;
            if (!groupId) return alert("×™×© ×œ×‘×—×•×¨ ×§×‘×•×¦×”");

            try {
              const assignRes = await fetch(`http://localhost:3000/api/groups/${groupId}/assign-volunteer`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ volunteer_id: volunteerId })
              });

              if (!assignRes.ok) throw new Error("×©×’×™××” ×‘×©×™×‘×•×¥");
              alert("âœ… ×”××ª× ×“×‘ ×©×•×‘×¥ ×‘×”×¦×œ×—×” ×œ×§×‘×•×¦×”");
              location.reload();
            } catch (err) {
              console.error("×©×’×™××” ×‘×©×™×‘×•×¥ ××ª× ×“×‘:", err);
              alert("âš ï¸ ×©×’×™××” ×‘×©×™×‘×•×¥");
            }
          });
        }
      } catch (err) {
        console.error("âš  ×©×’×™××” ×›×œ×œ×™×ª:", err);
        alert("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×£");
      }
    });
  </script>

</body>
</html>
