<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>×©×™×‘×•×¥ ××ª× ×“×‘ ×œ×™×œ×“</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>

<body class="assign-volunteer-page">
  <header>
    <nav>
      <ul>
        <li><a href="../index.html">×“×£ ×”×‘×™×ª</a></li>
        <li><a href="../content/content_list.html">×¤×•×¨×˜×œ ×ª×•×›×Ÿ</a></li>
        <li><a href="../children/profile_list.html">×¤×¨×•×¤×™×œ ×™×œ×“×™×</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>ğŸŒ» ×©×™×‘×•×¥ ×œ×§×‘×•×¦×”</h1>
    <p id="volunteerInfo">×˜×•×¢×Ÿ ××™×“×¢ ×¢×œ ×”××ª× ×“×‘...</p>

    <form id="assignForm" class="assign-form" style="display:none;">
      <label for="studentSelect">×‘×—×¨ ×™×œ×“ ×œ×©×™×‘×•×¥:</label>
      <select id="studentSelect" required>
        <option value="">-- ×‘×—×¨ ×™×œ×“ --</option>
      </select>
      <button type="submit">×©×‘×¥</button>
    </form>

    <a href="volunteer_list.html" class="assign-btn">â¬… ×—×–×¨×” ×œ×¨×©×™××ª ××ª× ×“×‘×™×</a>
  </main>

  <footer>
    Â© 2025 ×¢××•×ª×ª ×—×× ×™×•×ª - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
  </footer>

  <script>
    const role = localStorage.getItem("role");
    if (role !== "admin") {
      alert("×’×™×©×” ×–×• ×–××™× ×” ×¨×§ ×œ×× ×”×œ.");
      window.location.href = "../index.html";
    }

    const urlParams = new URLSearchParams(window.location.search);
    const volunteerId = urlParams.get("id");
    const volunteerInfo = document.getElementById("volunteerInfo");
    const studentSelect = document.getElementById("studentSelect");
    const assignForm = document.getElementById("assignForm");

    if (!volunteerId) {
      volunteerInfo.textContent = "âŒ ×—×¡×¨ ××–×”×” ××ª× ×“×‘ ×‘×›×ª×•×‘×ª ×”×“×£.";
    } else {
      loadVolunteerAndChildren(volunteerId);
    }

    async function loadVolunteerAndChildren(id) {
      try {
        const res = await fetch(`/api/volunteers/${id}`);
        const volunteer = await res.json();

        const groupLabel = volunteer.group?.age_category || "×œ× ×©×•×‘×¥";
        volunteerInfo.textContent = `×©×™×‘×•×¥ ×¢×‘×•×¨: ${volunteer.full_name} | ×§×‘×•×¦×ª ×’×™×œ: ${groupLabel}`;

        const childrenRes = await fetch(`/api/children`);
        const children = await childrenRes.json();

        const filtered = children.filter(c =>
          c.group?.age_category === volunteer.group?.age_category && !c.assigned_volunteer
        );

        if (filtered.length === 0) {
          studentSelect.innerHTML = `<option>âš ï¸ ××™×Ÿ ×™×œ×“×™× ×–××™× ×™× ×œ×©×™×‘×•×¥ ×‘×§×‘×•×¦×” ×–×•</option>`;
        } else {
          filtered.forEach(child => {
            const option = document.createElement("option");
            option.value = child._id;
            option.textContent = `${child.first_name} ${child.last_name}`;
            studentSelect.appendChild(option);
          });
          assignForm.style.display = "block";
        }

        assignForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const studentId = studentSelect.value;

          try {
            const assignRes = await fetch("/api/volunteers/assign", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                volunteer_id: volunteer._id,
                child_id: studentId
              })
            });

            if (!assignRes.ok) throw new Error("×©×’×™××” ×‘×©×™×‘×•×¥");
            alert("âœ… ×”×©×™×‘×•×¥ ×‘×•×¦×¢ ×•× ×©×œ×—×• ×”×•×“×¢×•×ª");
            localStorage.setItem("refreshVolunteers", "true");
            window.location.href = "volunteer_list.html";
          } catch (err) {
            alert("âŒ ×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×©×™×‘×•×¥");
            console.error(err);
          }
        });

      } catch (err) {
        volunteerInfo.textContent = "âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”××ª× ×“×‘";
        console.error(err);
      }
    }
  </script>
</body>
</html>
