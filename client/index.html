<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×“×£ ×”×‘×™×ª - ×¢××•×ª×ª ×—×× ×™×•×ª</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="children/profile_list.html">ğŸ‘¦ ×¤×¨×•×¤×™×œ×™ ×™×œ×“×™×</a></li>
        <li><a id="volunteers-link" href="volunteers/volunteer_list.html">ğŸ¤ ××ª× ×“×‘×™×</a></li>
        <li><a href="content/content_list.html">ğŸ“š ×¤×•×¨×˜×œ ×ª×•×›×Ÿ</a></li>
        <li><a href="children/tracking_and_reports.html">ğŸ“Š ×“×•"×—×•×ª ×•×¡×˜×˜×™×¡×˜×™×§×”</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1 id="welcome-message">××¢×¨×›×ª × ×™×”×•×œ - ×¢××•×ª×ª ×—×× ×™×•×ª</h1>
    <p style="text-align: center; font-size: 18px;">××¢×¨×›×ª ×¤× ×™××™×ª ×œ× ×™×”×•×œ ×¤×¢×™×œ×•×ª ×”×¢××•×ª×”.</p>

    <!-- ×ª×¦×•×’×ª ×× ×”×œ×ª -->
    <div id="admin-section" style="display: none;">
      <div class="dashboard">
        <h2>××™×“×¢ ×¢×“×›× ×™ (×× ×”×œ×ª)</h2>
        <ul>
          <li>ğŸ“Œ ×™×œ×“×™× ×¨×©×•××™×: <strong id="children-count">×˜×•×¢×Ÿ...</strong></li>
          <li>ğŸ¤ ××ª× ×“×‘×™× ×¤×¢×™×œ×™×: <strong id="volunteers-count">×˜×•×¢×Ÿ...</strong></li>
          <li>ğŸ“ ×§×‘×¦×™× ×©×”×•×¢×œ×• ×”×©×‘×•×¢: <strong id="uploads-count">×˜×•×¢×Ÿ...</strong></li>
        </ul>
      </div>
      <div class="action-buttons">
        <a href="children/add_child_form.html">â• ×”×•×¡×¤×ª ×™×œ×“</a>
        <a href="volunteers/add_volunteer.html">ğŸ¤ ×”×•×¡×¤×ª ××ª× ×“×‘</a>
        <a href="content/upload_content.html">ğŸ“„ ×”×•×¡×¤×ª ×ª×•×›×Ÿ</a>
      </div>
    </div>

    <!-- ×ª×¦×•×’×ª ××ª× ×“×‘ -->
    <div id="volunteer-section" style="display: none;">
      <div class="dashboard">
        <h2>××™×“×¢ ×¢×“×›× ×™ (××ª× ×“×‘)</h2>
        <ul>
          <li>ğŸ‘¦ ×™×œ×“×™× ××©×•×‘×¦×™× ××œ×™×™: <strong id="assigned-children-count">×˜×•×¢×Ÿ...</strong></li>
          <li>ğŸ“š ×ª×›× ×™× ×œ×”×¢×‘×¨×” ×”×©×‘×•×¢: <strong id="weekly-content-count">×˜×•×¢×Ÿ...</strong></li>
        </ul>
      </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <button onclick="logout()" class="btn">ğŸšª ×”×ª× ×ª×§</button>
    </div>
  </main>

  <footer>
    Â© 2025 ×¢××•×ª×ª ×—×× ×™×•×ª - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª
  </footer>

  <script>
    const BASE_URL = "https://hamaniot-3.onrender.com";
    async function checkLogin() {
      try {
        const res = await fetch("${BASE_URL}/api/auth/check", {
          credentials: "include"
        });

        if (!res.ok) {
          console.warn("ğŸ”’ ×œ× ××—×•×‘×¨ - ×¡×˜×˜×•×¡:", res.status);
          const error = await res.json();
          console.warn("ğŸ§¾ ×”×•×“×¢×ª ×©×’×™××” ××”×©×¨×ª:", error.message);
          window.location.href = "login.html";
          return null;
        }

        const user = await res.json();
        console.log("âœ… ××—×•×‘×¨ ×›:", user);
        return user;
      } catch (err) {
        console.error("âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×”×ª×—×‘×¨×•×ª:", err);
        window.location.href = "login.html";
        return null;
      }
    }

    async function logout() {
      await fetch("${BASE_URL}/api/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      window.location.href = "login.html";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("ğŸ“„ ×˜×•×¢×Ÿ ×“×£ ×”×‘×™×ª, ×‘×•×“×§ ×”×ª×—×‘×¨×•×ª...");
      const user = await checkLogin();
      if (!user) return;

      const { name, role, group } = user;
      document.getElementById("welcome-message").textContent = `×©×œ×•× ${name} ğŸ‘‹`;

      localStorage.setItem("role", role);
      if (role === "volunteer" && group?._id) {
        localStorage.setItem("group", group._id);
      }

      if (role === "admin") {
        document.getElementById("admin-section").style.display = "block";
        console.log("ğŸ›  ××¦×™×’ ×ª×¤×¨×™×˜ ×× ×”×œ×ª");

        try {
          const res = await fetch("${BASE_URL}/api/stats", {
            credentials: "include"
          });
          const data = await res.json();
          document.getElementById("children-count").textContent = data.children || 0;
          document.getElementById("volunteers-count").textContent = data.volunteers || 0;
          document.getElementById("uploads-count").textContent = data.uploads || 0;
          document.getElementById("messages-count").textContent = data.messages || 0;
        } catch (err) {
          console.error("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×× ×”×œ×ª:", err);
        }
      }

      if (role === "volunteer") {
        document.getElementById("volunteer-section").style.display = "block";
        console.log("ğŸ›  ××¦×™×’ ×ª×¤×¨×™×˜ ××ª× ×“×‘");

        const link = document.getElementById("volunteers-link");
        if (link) link.style.display = "none"; // ×”×¡×ª×¨×ª ×”×§×™×©×•×¨

        try {
          const res = await fetch("${BASE_URL}/api/volunteers/volunteer-dashboard", {
            credentials: "include"
          });
          const data = await res.json();
          document.getElementById("assigned-children-count").textContent = data.assignedChildren || 0;
          document.getElementById("weekly-content-count").textContent = data.weeklyContent || 0;
        } catch (err) {
          console.error("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××ª× ×“×‘:", err);
        }
      }
    });
  </script>
</body>
</html>
